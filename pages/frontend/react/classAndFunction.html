<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一、函数式组件 | 没想好</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/egg.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.efec8a6d.css" as="style"><link rel="preload" href="/assets/js/app.824c4530.js" as="script"><link rel="preload" href="/assets/js/2.043a423b.js" as="script"><link rel="preload" href="/assets/js/12.a2f0bc1c.js" as="script"><link rel="prefetch" href="/assets/js/10.9999ba99.js"><link rel="prefetch" href="/assets/js/11.cf4c37ac.js"><link rel="prefetch" href="/assets/js/13.0a766736.js"><link rel="prefetch" href="/assets/js/14.edf7d5e1.js"><link rel="prefetch" href="/assets/js/15.5fa85732.js"><link rel="prefetch" href="/assets/js/16.a6738b34.js"><link rel="prefetch" href="/assets/js/17.81f5c19d.js"><link rel="prefetch" href="/assets/js/3.d9bc2229.js"><link rel="prefetch" href="/assets/js/4.db16b84d.js"><link rel="prefetch" href="/assets/js/5.ce22f85c.js"><link rel="prefetch" href="/assets/js/6.078ab10c.js"><link rel="prefetch" href="/assets/js/7.c5848028.js"><link rel="prefetch" href="/assets/js/8.7273b2bd.js"><link rel="prefetch" href="/assets/js/9.5b8597d9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.efec8a6d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/egg.png" alt="没想好" class="logo"> <span class="site-name can-hide">没想好</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/frontend/react/classAndFunction.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  react
</a></li><li class="dropdown-item"><!----> <a href="/pages/frontend/vue/vue2.html" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/pages/frontend/js/replace.html" class="nav-link">
  js
</a></li><li class="dropdown-item"><!----> <a href="/pages/frontend/css/white-spaceAndword-break.html" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/pages/frontend/vuepress/vuepress.html" class="nav-link">
  vuepress
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/backend/nodejs/test.html" class="nav-link">
  nodejs
</a></li></ul></div></div><div class="nav-item"><a href="/pages/life/test.html" class="nav-link">
  生活记录
</a></div><div class="nav-item"><a href="https://github.com/123456wjw" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/frontend/react/classAndFunction.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  react
</a></li><li class="dropdown-item"><!----> <a href="/pages/frontend/vue/vue2.html" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/pages/frontend/js/replace.html" class="nav-link">
  js
</a></li><li class="dropdown-item"><!----> <a href="/pages/frontend/css/white-spaceAndword-break.html" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/pages/frontend/vuepress/vuepress.html" class="nav-link">
  vuepress
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/backend/nodejs/test.html" class="nav-link">
  nodejs
</a></li></ul></div></div><div class="nav-item"><a href="/pages/life/test.html" class="nav-link">
  生活记录
</a></div><div class="nav-item"><a href="https://github.com/123456wjw" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>react</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/frontend/react/classAndFunction.html" aria-current="page" class="active sidebar-link">函数式组件与类组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/frontend/react/classAndFunction.html#一、函数式组件" class="sidebar-link">一、函数式组件</a></li><li class="sidebar-sub-header"><a href="/pages/frontend/react/classAndFunction.html#二、函数式组件与类组件的区别" class="sidebar-link">二、函数式组件与类组件的区别</a></li><li class="sidebar-sub-header"><a href="/pages/frontend/react/classAndFunction.html#三、感想" class="sidebar-link">三、感想</a></li></ul></li><li><a href="/pages/frontend/react/zujiantongxin.html" class="sidebar-link">函数式组件通信</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>js</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>css</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/pages/frontend/vuepress/vuepress.html" class="sidebar-link">vueperss博客搭建</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="一、函数式组件"><a href="#一、函数式组件" class="header-anchor">#</a> 一、函数式组件</h2> <p>1.函数组件
    在hooks出现之前，react中的函数组件通常只考虑负责UI的渲染，没有自身的状态没有业务逻辑代码，是一个纯函数。下面这个函数组件就是一个纯函数，它的输出只由参数props决定，不受其他任何因素影响。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">.</span>mouse
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> height<span class="token operator">:</span> <span class="token string">'100%'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>The mouse position <span class="token function">is</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>x<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>y<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>但是这种函数组件一旦我们需要给组件加状态，那就只能将组件重写为类组件，因为函数组件没有实例，没有生命周期。所以我们说在hook之前的函数组件和类组件最大的区别又是<strong>状态</strong>的有无。</p> <hr> <p>2.hooks
    hooks为函数组件提供了状态，也支持在函数组件中进行数据获取、订阅事件解绑事件等等。下面先介绍几个最基本的hook作为基础知识。</p> <p>1）useState，通过useState为组件提供状态。这是一个简单的useState例子，<a href="https://codesandbox.io/s/jolly-frost-s8jcu" target="_blank">计数器</a>，useState的参数是state的初始值，他只有在组件第一次渲染的时候会生效，他的返回值是一个数组，第一个是state，第二个是设置state的函数。</p> <p>2）useEffect，副作用。通常在副作用中进行ajax请求，事件的绑定与解绑，设置定时器与清除等等。这是一个简单的useEffect的例子，<a href="https://codesandbox.io/s/useeffectjiandanlizi-r848w" target="_blank">useEffect基本用法</a>，useEffect第一个参数是一个回调函数，在里面进行业务逻辑代码的书写；第二个参数是依赖项数组，如果数组中的依赖发生变化，那么该副作用就会重新执行，如果不设置第二个参数，那么当该组件每渲染一次，副作用就会执行一次；当然如果设置空数组，那么该副作用只会在组件初次渲染时执行一次。</p> <p>注意，有时我们会需要清除副作用，例如，<a href="https://codesandbox.io/s/boring-dew-s7kok" target="_blank">定时器</a>，useEffect的回调函数接受一个返回值，这个返回值是一个函数，在这个函数中我们可以执行清除副作用操作，上例中，如果不清除定时器，那么副作用每执行一次，就会产生一个新的定时器，造成内存溢出。</p> <p>3）useCallback，用于缓存函数，第一个参数为要缓存的函数，第二个参数为依赖项数组，如果依赖发生了变化，那么就会生成一个新的函数；否则当组件重新渲染时，不会重新定义这个函数，而是会取缓存。</p> <p>4）useMemo，用于缓存函数的返回值，第一个参数为要缓存的函数（注意实际被缓存的是函数被执行过后的值），第二个参数为依赖项数组，如果依赖发生了变化，那么就会重新执行这个函数，得到新的返回值；否则当组件重新渲染时，不会重新执行这个函数，而是直接取被缓存的该函数的返回值。</p> <p>useCallback，useMemo都是用作优化函数式组件性能的，这里不做过多讲解。</p> <h2 id="二、函数式组件与类组件的区别"><a href="#二、函数式组件与类组件的区别" class="header-anchor">#</a> 二、函数式组件与类组件的区别</h2> <p>首先，需要明确的一点是，虽然函数组件和类组件的优化策略不太相同，但是在优化得当的情况下，性能的差异在现代浏览器中是很小的。性能主要取决于代码，而不是选择函数组件和类组件本身的差异上，所以不用从性能角度考虑该选择哪种方式写代码。</p> <p>下面要讲的是函数式组件与类组件的一些区别，</p> <p>1）状态同步问题，<strong>函数组件会捕获当前渲染时所用的值</strong>。但往往这被忽略了。</p> <p>先来看下这个例子，<a href="https://codesandbox.io/s/fragrant-shape-vneoc" target="_blank">状态同步</a>，按照下面步骤进行操作：</p> <div class="language-List line-numbers-mode"><pre class="language-text"><code>1.先输入111
2.点击按钮
3.再输入222
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>通过这个操作，我们可以发现，不管是props还是自身的state，函数式组件中弹出的值都是点击按钮那一刻的值，而类组件都是最新的值。</p> <p>现在我们来分析一下出现这种差异性的原因。</p> <p>首先我们知道，不论是函数式组件还是类组件，只要状态或者props发生变化了那就会重新渲染，而且对于没有进行过性能优化的子组件来说，只要父组件重新渲染了，子组件就会重新渲染。而且在react中<strong>props是不可变的，而this是一直在改变的</strong>。所以类组件中的方法可以获取到最新的实例即this，而函数组件在渲染的时候因为<strong>闭包</strong>的原因捕获了渲染时的值，所以改例子会出现这种现象。</p> <p>那我们如何让类组件获取渲染时的值或者让函数组件获取最新值呢，看下面这个例子，<a href="https://codesandbox.io/s/eloquent-glitter-zh900" target="_blank">类组件利用闭包，函数组件利用useRef</a>，对于类组件我们将函数定义在render函数当中，这样我们就形成了一个闭包，就可以像函数组件一样在渲染的时候捕获相应的值；而对于函数组件我们通过useRef来实现获取最新的值，因为<strong>useRef的返回值也是可变的</strong>。</p> <p>再来看一个关于状态同步的问题，<a href="https://codesandbox.io/s/sparkling-morning-tkph5" target="_blank">函数组件与类组件定时器</a>，我们发现两个组件实现的效果是一致的。但是我们仔细看一下函数组件，我们在useEffect中创建了一个定时器，但是每当count值改变，组件重新渲染这时就会把这个定时器清除，并且重新创建一个定时器，这很明显不是我们想要的。但是如果把count依赖去掉，会发现count值永远停留在了1。造成这个原因也是个上面讲的函数组件在渲染时捕获了所用的值，useEffect中的定时器在渲染时捕获到的count值为0，所以count值永远是从0变到1。</p> <p>这就是讲的第一个差异，即<strong>状态的同步</strong>问题。</p> <p>2）函数组件useEffect与类组件生命周期</p> <p>先介绍几个类组件中的生命周期函数：</p> <p>组件首次挂载完成：componentDidMount() {}、组件是否需要更新：shouldComponentUpdate() {}、组件更新完成：componentDidUpdate() {}
组件将要卸载：componentWillUnmount() {}。通常在componentDidMount中我们会进行一些依赖于DOM的初始化，进行网络请求，事件绑定，订阅等等；在componentDidUpdate进行一些DOM操作和网络请求；在componentWillUnmount会进行一些事件解绑和取消订阅的操作。</p> <p>对比函数组件，这些操作我们都可以通过useEffect这个hook来实现，但是useEffect管理起来要比类组件中生命周期更加繁琐，尤其是在业务逻辑复杂的情况下。</p> <p>首先，当我们在执行useEffect时，为了避免每次 render 都去执行它的 callback，我们通常会传入第二个参数依赖数组。这样，只有当依赖数组发生变化时，才会执行 useEffect 的回调函数。但是当业务逻辑复杂，可能就会导致以来过多的问题。所以可能在项目中会出现下面这样的代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> searchState<span class="token punctuation">,</span> address<span class="token punctuation">,</span> status<span class="token punctuation">,</span> personA<span class="token punctuation">,</span> personB<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> page<span class="token punctuation">,</span> size<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果一个组件中有多处这样的代码，那光是维护这些依赖就已经比较复杂，就不用说里面的业务逻辑了。由此引发几个思考：</p> <ul><li>1.该使用多个state还是单个state？</li> <li>2.如何减少依赖项？</li></ul> <p>第一个问题，因为通过useState定义的state常常会成为依赖项注入依赖数组，如果把所有state分开，那么势必会造成依赖过多的问题。但是如果定义单个state，就像类组件中的this.state一样，那么就会造成所有的业务逻辑都在一个useEffect中，不利于代码的维护和通过useEffect的拆分来实现业务逻辑的分离。所以结合实际情况，可以把同一类的状态定义在一起，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//分页属性可以归类为同一类</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>pagination<span class="token punctuation">,</span> setPagination<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>current<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> pageSize<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//位置属性也可以归类为同一类</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> setPosition<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>left<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> top<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>对于减少依赖项我们通常有一下几种做法：</p> <ul><li>将 Hook 拆分为更小的单元，每个 Hook 依赖于各自的依赖数组。</li> <li>通过合并相关的 state，将多个依赖值聚合为一个。</li> <li>通过 setState 回调函数获取最新的 state，以减少外部依赖，参考这个<a href="https://codesandbox.io/s/condescending-sara-gu1y3" target="_blank">定时器</a>例子。</li> <li>通过useReducer将更新与动作解耦。上个方法的缺陷在于如果依赖了两个state那么我们又得添加依赖项，观察以下代码</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> c <span class="token operator">+</span> step<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">clearInterval</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>step<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>我们发现，这里的step仍然无法省略，解决办法就是通过<strong>useReducer</strong>来实现<strong>更新与动作解耦</strong>，看这个例子，<a href="https://codesandbox.io/s/blissful-snow-sjq68" target="_blank">useReducer实现更新与动作解耦</a>，在代码中我们可以看出在useEffect中的更新操作只依赖了dispatch这一个函数，并且这个函数是永远不会变得，所以这里不需要任何依赖。</p> <p>针对依赖数组的维护，我们在下面性能优化中还会继续提到。<strong>由上可见，当组件，业务逻辑很复杂的时候，响应式的useEffect是很麻烦去管理的。而类组件会减少我们在管理上的压力。</strong></p> <p>3）性能优化</p> <p>类组件shouldComponentUpdate这个生命周期，通常我们在这个生命周期中进行组件的优化，通过判断前一个props和当前的props是否有变化来判断组件是否需要渲染，或者通过PureComponent实现；</p> <p>那么在函数组件中我们通过React.memo()来实现，具体看下面这个例子，<a href="https://codesandbox.io/s/amazing-hermann-4287x" target="_blank">React.memo()</a>，点击增加count按钮，观察console，发现只打印了“NotUseMemoComponent ”，这就说明当父组件传递给子组件的值没有发生改变的情况下，使用了memo包裹的子组件不会因为父组件重新渲染而重新渲染，而没有使用memo包裹的组件只要父组件渲染了，子组件也会渲染。</p> <p>但是当父组件将自己定义的引用类型的值传递给子组件时，即使值没有改变。但是由于每次渲染的时候都会生成新的变量，导致引用发生了改变，所以子组件仍然会渲染，具体看这个例子，<a href="https://codesandbox.io/s/dazzling-sky-vp8eu" target="_blank">传递函数对象或者数组</a>，由打印可知，每次父组件重渲染都会生成新的sayHi函数，这就使得子组件重渲染并且由于useEffect依赖了这个函数，useEffect也重新执行。这就会导致子组件做了很多无用的渲染。</p> <p>针对上面这个现象，通常考虑使用useCallback，useMemo来实现优化，看下面这个例子，<a href="https://codesandbox.io/s/usecallbackusememoyouhua-zzgxp" target="_blank">useCallback,useMemo</a>，现在我们发现即使我们不停的点击按钮，也不会重新触发子组件的渲染，并且useEffect也不会执行。这是因为useCallback，useMemo在依赖数组没变的情况下，都读取了缓存，没有重新生成函数或者对象。</p> <p>注意，用useState定义的状态和改变状态的方法如果成为了依赖，不会因为重渲染而导致回调函数被重新执行，因此不需要用useCallback或useMemo包裹。</p> <p>4）代码复用</p> <p>假设现在有A、B、C、D四个组件，B和D为UI不同但是业务逻辑类似的组件，都是从服务端获取数据后循环展示列表数据，结构大致如下</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>A</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>B</span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>A</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>C</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>D</span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>C</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>函数组件：<strong>自定义hook</strong></p> <p>原本我们需要在B和D组件中都进行状态的定义和数据的获取，B和D组件如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 组件B/D：</span>
<span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span>useState<span class="token punctuation">,</span> useEffect<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>
<span class="token keyword">function</span> <span class="token constant">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> <span class="token punctuation">[</span>lists<span class="token punctuation">,</span> setLists<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> <span class="token function-variable function">getLists</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'xxx/xxxx'</span><span class="token punctuation">)</span> <span class="token comment">//数据请求地址</span>
			<span class="token function">setLists</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token function">getLists</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span><span class="token punctuation">(</span>
		<span class="token comment">//渲染</span>
		<span class="token operator">&lt;</span><span class="token operator">&gt;</span>
			<span class="token punctuation">{</span>lists<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
	<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token constant">B</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>现在可以自定义一个hook，将同样的代码只写一次，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// useAxios.js：</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>useState<span class="token punctuation">,</span> useEffect<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>
<span class="token keyword">function</span> <span class="token function">useAxios</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> <span class="token punctuation">[</span>lists<span class="token punctuation">,</span> setLists<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> <span class="token function-variable function">getLists</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
			<span class="token function">setLists</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token function">getLists</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> lists
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> useAxios

<span class="token comment">// 组件B/D：</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> useAxios <span class="token keyword">from</span> <span class="token string">'../customHooks/useAxios'</span>
<span class="token keyword">function</span> <span class="token constant">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> lists <span class="token operator">=</span> <span class="token function">useAxios</span><span class="token punctuation">(</span><span class="token string">'xxx/xxxx'</span><span class="token punctuation">)</span><span class="token comment">//数据请求地址</span>
	<span class="token keyword">return</span><span class="token punctuation">(</span>
		<span class="token comment">//渲染</span>
		<span class="token operator">&lt;</span><span class="token operator">&gt;</span>
			<span class="token punctuation">{</span>lists<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
	<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token constant">B</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>下面对比用类组件实现：</p> <p>类组件：<strong>HOC(高阶组件)与Render Props</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 组件B/D:</span>
<span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span>Component<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>
<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
	<span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    	<span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> lists<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

    <span class="token function">componentWillMount</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'xxx/xxxx'</span><span class="token punctuation">)</span><span class="token comment">//数据请求地址</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> lists<span class="token operator">:</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">render</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//渲染</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>
			<span class="token operator">&lt;</span><span class="token operator">&gt;</span>
				<span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>lists<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
			<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
		<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token constant">B</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>利用HOC（高阶组件写法如下）：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// wrapWithAjax.js(这是一个HOC):</span>
<span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span>Component<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>
<span class="token keyword">const</span> <span class="token function-variable function">wrapWithAjax</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">WrappedComponent<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> Component <span class="token punctuation">{</span>
		<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> lists<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		
		<span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token comment">//数据请求地址</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> lists<span class="token operator">:</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span>
    	<span class="token punctuation">}</span>
		
		<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token punctuation">(</span>
				<span class="token operator">&lt;</span>WrappedComponent lists<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>lists<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
			<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// B/D组件:</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> wrapWithAjax <span class="token keyword">from</span> <span class="token string">'./wrapWithAjax'</span>
<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//渲染</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>
			<span class="token operator">&lt;</span><span class="token operator">&gt;</span>
				<span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>lists<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
			<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
		<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token constant">B</span> <span class="token operator">=</span> <span class="token function">wrapWithAjax</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">,</span> <span class="token string">'xxx/xxxx'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token constant">B</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>通过上面这个例子，可以清除的发现函数式组件自定义hook的方式使用的代码量更少，而且相比HOC更加直观，代码可读性更高也更易于理解。而且通过观察HOC的代码，一个HOC相当于对原来的组件做了一层代理，那么就避免不了‘嵌套地狱’的出现。</p> <h2 id="三、感想"><a href="#三、感想" class="header-anchor">#</a> 三、感想</h2> <p>经过以上分析，我对hook的优缺点有以下一些总结：</p> <p>优点：
    1. 通过自定义hook更加易于复用代码
    2. 函数式编程代码更加清晰
    3. 更方便拆分组件
    4. 不用考虑类组件中的this</p> <p>缺点：
    1. 响应式的依赖，当业务逻辑复杂时，依赖更加难以管理和维护
    2. 状态不同步，异步逻辑中可能会出现状态不是最新的（具体需要看需求）</p> <p>所以，当业务逻辑复杂，用类组件更易于我们维护，也相应降低了开发成本。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/pages/frontend/react/zujiantongxin.html">
        函数式组件通信
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.824c4530.js" defer></script><script src="/assets/js/2.043a423b.js" defer></script><script src="/assets/js/12.a2f0bc1c.js" defer></script>
  </body>
</html>
